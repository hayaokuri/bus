<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>バス接近情報 <span id="title-from-stop">{{ from_stop }}</span> → <span id="title-to-stop">{{ to_stop }}</span></title>
    <style>
        /* ... (CSSは変更なし) ... */
        .direction-switcher {
            text-align: center;
            margin-bottom: 20px;
        }
        .direction-switcher a {
            display: inline-block;
            padding: 8px 15px;
            background-color: #0d6efd;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            margin: 0 5px;
            font-size: 0.9em;
        }
        .direction-switcher a.active {
            background-color: #0a58ca;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>バス接近情報</h1>

        <div class="direction-switcher">
            <a href="?direction=sannodai_to_isehara" id="link_sannodai_to_isehara">産業能率大学 発 → 伊勢原駅北口 行き</a>
            <a href="?direction=isehara_to_sannodai" id="link_isehara_to_sannodai">伊勢原駅北口 発 → 産業能率大学 行き</a>
        </div>

        <div class="header-info">
            <p><strong>区間:</strong> <span id="from-stop-name">{{ from_stop }}</span> → <span id="to-stop-name">{{ to_stop }}</span></p>
            <p><strong>現在時刻:</strong> <span id="current-time-display">時刻取得中...</span></p>
            <p>
                <strong>サーバー状態:</strong>
                <span id="server-status-indicator" class="indicator"></span>
                <span id="server-status-text">確認中...</span>
            </p>
            <p><strong>運用日数:</strong> <span id="uptime-days">{{ initial_uptime_days | default('--') }}</span> 日目</p>
        </div>
        </div>

    <script>
        // ... (updateCurrentTime 関数は変更なし) ...
        // setInterval(updateCurrentTime, 1000);
        // updateCurrentTime(); // これは fetchAndUpdateData の初回呼び出し後などに移動した方が良いかも

        const dataUpdateInterval = parseInt("{{ config.get('ACTIVE_DATA_FETCH_INTERVAL', 10) }}", 10) * 1000;
        let currentDirection = '{{ current_direction | default("sannodai_to_isehara") }}'; // Pythonから渡された現在の方向

        function setActiveLink() {
            document.getElementById('link_sannodai_to_isehara').classList.remove('active');
            document.getElementById('link_isehara_to_sannodai').classList.remove('active');
            if (currentDirection === 'sannodai_to_isehara') {
                document.getElementById('link_sannodai_to_isehara').classList.add('active');
            } else if (currentDirection === 'isehara_to_sannodai') {
                document.getElementById('link_isehara_to_sannodai').classList.add('active');
            }
        }
        setActiveLink(); // 初期表示時にアクティブリンクを設定

        async function fetchAndUpdateData() {
            try {
                // URLSearchParams を使って現在のURLから direction を取得、なければデフォルト値
                const params = new URLSearchParams(window.location.search);
                const directionForAPI = params.get('direction') || currentDirection;

                const response = await fetch(`/api/data?direction=${directionForAPI}`); // APIにdirectionを渡す
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                // 区間情報をAPIから取得したもので更新
                document.getElementById('from-stop-name').textContent = data.from_stop;
                document.getElementById('to-stop-name').textContent = data.to_stop;
                // ページタイトルも更新 (オプション)
                document.getElementById('title-from-stop').textContent = data.from_stop;
                document.getElementById('title-to-stop').textContent = data.to_stop;


                // サーバー状態インジケーターとテキスト
                const statusIndicator = document.getElementById('server-status-indicator');
                const statusText = document.getElementById('server-status-text');
                if (statusIndicator && statusText) {
                    if (data.system_status) {
                        if (data.system_status.healthy) {
                            statusIndicator.className = 'indicator green';
                            statusText.textContent = '作動中';
                        } else if (data.system_status.warning) {
                            statusIndicator.className = 'indicator yellow';
                            statusText.textContent = '一部注意あり';
                        } else {
                            statusIndicator.className = 'indicator red';
                            statusText.textContent = '停止またはエラー';
                        }
                    } else {
                        statusIndicator.className = 'indicator';
                        statusText.textContent = '状態不明';
                    }
                }

                // 運用日数
                const uptimeDaysSpan = document.getElementById('uptime-days');
                if (uptimeDaysSpan && data.uptime_days !== undefined) {
                    uptimeDaysSpan.textContent = data.uptime_days;
                }

                // 天気情報
                const weatherInfoArea = document.getElementById('weather-info-area');
                let weatherHtml = '';
                if (data.weather_data) {
                    if (data.weather_data.error_message) {
                        weatherHtml = `<p class="error-message">天気情報: ${data.weather_data.error_message}</p>`;
                    } else if (data.weather_data.condition) {
                        weatherHtml = `<p><strong>伊勢原の天気:</strong> ${data.weather_data.description || data.weather_data.condition}
                                       ${data.weather_data.temp_c !== null ? ` (${data.weather_data.temp_c.toFixed(1)}℃)` : ''}
                                       ${data.weather_data.is_rain ? ' <span class="urgent-text">傘を忘れずに！</span>' : ''}
                                     </p>`;
                    } else {
                        weatherHtml = '<p>天気情報なし</p>';
                    }
                } else {
                    weatherHtml = '<p>天気情報取得エラー</p>';
                }
                weatherInfoArea.innerHTML = weatherHtml;

                // アプリ状態メッセージ
                const appStateMsgDisplay = document.getElementById('app-state-message-display');
                if (appStateMsgDisplay) {
                    appStateMsgDisplay.textContent = data.app_state_message || 'N/A';
                }

                // バス情報最終更新時刻
                const busLastUpdatedSpan = document.getElementById('bus-last-updated');
                if (busLastUpdatedSpan) {
                    busLastUpdatedSpan.textContent = data.bus_last_updated_str || "N/A";
                }

                // バス一覧
                const busInfoContainer = document.getElementById('bus-info-container');
                let busesHtml = '';
                if (data.bus_error_message) {
                    busesHtml = `<p class="error-message" data-bus-error>バス情報取得エラー: ${data.bus_error_message}</p>`;
                } else if (data.buses_to_display && data.buses_to_display.length > 0) {
                    busesHtml += '<ul class="bus-list">';
                    data.buses_to_display.forEach((bus, index) => {
                        busesHtml += `
                            <li class="bus-item ${bus.is_urgent ? 'urgent' : ''}">
                                <p>
                                    <strong>${index + 1}. ${bus.departure_time.replace(/\(予定通り\)|\(予定\)|\(遅延可能性あり\)/g, '').trim()}</strong>
                                    ${bus.departure_time.includes("(予定通り)") ? ' (予定通り)' : ''}
                                    ${bus.departure_time.includes("(予定)") ? ' (予定)' : ''}
                                    ${bus.departure_time.includes("(遅延可能性あり)") ? ' (遅延可能性あり)' : ''}
                                    ${(bus.time_until_departure && !bus.departure_time.includes(bus.time_until_departure)) ? `<span class="time-until-text">(${bus.time_until_departure})</span>` : ''}
                                </p>
                                ${bus.status_text.includes("予定通り発車します") ? `<p class="details status-on-time">予定通り発車します</p>` : ''}
                                </li>`;
                    });
                    busesHtml += '</ul>';
                } else {
                    let noBusMsg = '現在、利用可能なバス情報はありません。';
                    if (data.app_state_message === '始発バス待機中 (早朝)' || (data.app_state_message && data.app_state_message.startsWith('始発バス待機中'))) {
                        noBusMsg = 'バスの運行情報を確認中です...';
                    } else if (data.app_state_message === '運行再開待機中 (終バス後など)') {
                         noBusMsg = 'バス運行再開待機中...';
                    }
                    busesHtml = `<p class="info-message" data-bus-info>${noBusMsg}</p>`;
                }
                busInfoContainer.innerHTML = busesHtml;

                // 現在の方向を更新し、アクティブなリンクを再設定
                if (data.current_direction) {
                    currentDirection = data.current_direction;
                    setActiveLink();
                }

            } catch (error) {
                console.error('データ更新に失敗しました:', error);
                const busInfoContainer = document.getElementById('bus-info-container');
                busInfoContainer.innerHTML = `<p class="error-message">データ更新に失敗しました。サーバーとの通信を確認してください。</p>`;

                const statusIndicator = document.getElementById('server-status-indicator');
                const statusText = document.getElementById('server-status-text');
                if (statusIndicator) statusIndicator.className = 'indicator red';
                if (statusText) statusText.textContent = '通信エラー';

                const uptimeDaysSpan = document.getElementById('uptime-days');
                if (uptimeDaysSpan) uptimeDaysSpan.textContent = 'N/A';
            }
        }

        // updateCurrentTime は最初に1回実行し、その後インターバルで実行
        updateCurrentTime();
        setInterval(updateCurrentTime, 1000);

        fetchAndUpdateData(); // 初回データ取得
        if (dataUpdateInterval > 0) {
            setInterval(fetchAndUpdateData, dataUpdateInterval);
            const nextFetchInfoEl = document.getElementById('next-fetch-info');
            if(nextFetchInfoEl && dataUpdateInterval > 1000) {
                 nextFetchInfoEl.textContent = `バス・天気情報は約${dataUpdateInterval/1000}秒間隔でサーバーから再取得します。`;
            } else if (nextFetchInfoEl) {
                 nextFetchInfoEl.textContent = `バス・天気情報は高頻度でサーバーから再取得設定です。`;
            }
        } else {
            const nextFetchInfoEl = document.getElementById('next-fetch-info');
            if(nextFetchInfoEl) {
                nextFetchInfoEl.textContent = 'バス・天気情報の自動更新は無効です。';
            }
        }
    </script>
</body>
</html>
