<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>バス接近情報 {{ from_stop }} → {{ to_stop }}</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 15px;
            background-color: #f0f2f5;
            color: #1c1e21;
            line-height: 1.6;
        }
        .container {
            max-width: 700px;
            margin: 20px auto;
            background-color: #fff;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        h1 {
            font-size: 2em;
            color: #0d6efd;
            margin-bottom: 10px;
            text-align: center;
            border-bottom: 2px solid #0d6efd;
            padding-bottom: 10px;
        }
        h2 {
            font-size: 1.4em;
            color: #343a40;
            margin-top: 30px;
            margin-bottom: 15px;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 8px;
        }
        .header-info p {
            margin: 6px 0;
            font-size: 1em;
        }
        .weather-info {
            font-size: 0.95em;
            padding: 10px 12px;
            background-color: #e0f7fa;
            border: 1px solid #b2ebf2;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        .weather-info strong { color: #00796b; }
        .bus-list { list-style: none; padding: 0; }
        .bus-item {
            background-color: #fff;
            border: 1px solid #e0e0e0;
            padding: 15px;
            margin-bottom: 12px;
            border-radius: 8px;
            transition: box-shadow 0.2s ease-in-out;
        }
        .bus-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .bus-item.urgent {
            border-left: 6px solid #d32f2f;
            background-color: #ffebee;
        }
        .bus-item.urgent strong, .bus-item.urgent .time-until-text {
            color: #c62828;
            font-weight: bold;
        }
        .bus-item strong { font-size: 1.15em; }
        .bus-item .details { font-size: 0.9em; color: #495057; margin-left: 20px; margin-top: 5px;}
        .error-message {
            color: #d32f2f;
            font-weight: bold;
            background-color: #ffcdd2;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #ef9a9a;
        }
        .info-message {
            color: #0d6efd;
            background-color: #cfe2ff;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #b6d4fe;
        }
        .footer {
            font-size: 0.85em;
            color: #6c757d;
            margin-top: 35px;
            text-align: center;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }
        .footer p { margin: 4px 0; }
        .urgent-text { color: #d32f2f; font-weight: bold; }
        .time-until-text { font-weight: normal; color: #333; }

        .indicator {
            display: inline-block;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background-color: #6c757d;
            margin-right: 6px;
            vertical-align: middle;
            border: 1px solid #5a6268;
            box-shadow: 0 0 3px rgba(0,0,0,0.2);
        }
        .indicator.green {
            background-color: #28a745;
            border-color: #1e7e34;
        }
        .indicator.yellow {
            background-color: #ffc107;
            border-color: #d39e00;
        }
        .indicator.red {
            background-color: #dc3545;
            border-color: #b21f2d;
        }
        .direction-switcher {
            text-align: center;
            margin-bottom: 20px;
        }
        .direction-switcher a {
            display: inline-block;
            padding: 8px 15px;
            background-color: #0d6efd;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            margin: 0 5px;
            font-size: 0.9em;
        }
        .direction-switcher a.active {
            background-color: #0a58ca;
            font-weight: bold;
        }
        .last-updated-label {
            font-size: 0.8em;
            color: #555;
            display: block;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>バス接近情報</h1>

        <div class="direction-switcher">
            <a href="?direction=sannodai_to_isehara" id="link_sannodai_to_isehara">産業能率大学 発 → 伊勢原駅北口 行き</a>
            <a href="?direction=isehara_to_sannodai" id="link_isehara_to_sannodai">伊勢原駅北口 発 → 産業能率大学 行き</a>
        </div>

        <div class="header-info">
            <p><strong>区間:</strong> <span id="from-stop-name">{{ from_stop }}</span> → <span id="to-stop-name">{{ to_stop }}</span></p>
            <p><strong>現在時刻:</strong> <span id="current-time-display">時刻取得中...</span></p>
            <p>
                <strong>サーバー状態:</strong>
                <span id="server-status-indicator" class="indicator"></span>
                <span id="server-status-text">確認中...</span>
            </p>
        </div>

        <div class="weather-info" id="weather-info-area">
            <p>天気情報取得中...</p>
            <span class="last-updated-label">最終更新: <span id="weather-last-updated">N/A</span></span>
        </div>

        <h2>【今後のバス】</h2>
        <p><small>バス情報最終更新: <span id="bus-last-updated">N/A</span></small></p>

        <div id="bus-info-container">
            <p class="info-message">バス情報を取得中です...</p>
        </div>
    </div>

    <div class="footer">
        <p><small>データ提供: 神奈川中央交通</small></p>
        <p><small>&copy; 2024 バス観測サイト</small></p>
    </div>

    <script>
        function updateCurrentTime() {
            const timeDisplay = document.getElementById('current-time-display');
            if (timeDisplay) {
                const now = new Date();
                const options = {
                    year: 'numeric', month: '2-digit', day: '2-digit',
                    hour: '2-digit', minute: '2-digit', second: '2-digit',
                    hour12: false, timeZone: 'Asia/Tokyo'
                };
                try {
                    const formatter = new Intl.DateTimeFormat('ja-JP', options);
                    const parts = formatter.formatToParts(now);
                    let year, month, day, hour, minute, second;
                    parts.forEach(part => {
                        if (part.type === 'year') year = part.value;
                        if (part.type === 'month') month = part.value;
                        if (part.type === 'day') day = part.value;
                        if (part.type === 'hour') hour = part.value;
                        if (part.type === 'minute') minute = part.value;
                        if (part.type === 'second') second = part.value;
                    });
                    if (year && month && day && hour && minute && second) {
                        timeDisplay.textContent = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')} ${hour.padStart(2, '0')}:${minute.padStart(2, '0')}:${second.padStart(2, '0')} JST`;
                    } else {
                        timeDisplay.textContent = now.toLocaleString('sv-SE', { timeZone: 'Asia/Tokyo' }) + " JST";
                    }
                } catch (e) {
                    console.warn("Intl.DateTimeFormat not fully supported, falling back.");
                    let jstHours = (now.getUTCHours() + 9) % 24;
                    timeDisplay.textContent =
                        now.getUTCFullYear() + '-' +
                        ('0' + (now.getUTCMonth() + 1)).slice(-2) + '-' +
                        ('0' + now.getUTCDate()).slice(-2) + ' ' +
                        ('0' + jstHours).slice(-2) + ':' +
                        ('0' + now.getUTCMinutes()).slice(-2) + ':' +
                        ('0' + now.getUTCSeconds()).slice(-2) + ' JST';
                }
            }
        }

        const dataUpdateInterval = parseInt("{{ config.get('ACTIVE_DATA_FETCH_INTERVAL', 10) }}", 10) * 1000;
        let currentDirection = '{{ current_direction | default("sannodai_to_isehara") }}';

        function setActiveLink() {
            const linkSannodai = document.getElementById('link_sannodai_to_isehara');
            const linkIsehara = document.getElementById('link_isehara_to_sannodai');
            if (linkSannodai) linkSannodai.classList.remove('active');
            if (linkIsehara) linkIsehara.classList.remove('active');

            if (currentDirection === 'sannodai_to_isehara' && linkSannodai) {
                linkSannodai.classList.add('active');
            } else if (currentDirection === 'isehara_to_sannodai' && linkIsehara) {
                linkIsehara.classList.add('active');
            }
        }
        setActiveLink();

        async function fetchAndUpdateData() {
            try {
                const params = new URLSearchParams(window.location.search);
                const directionForAPI = params.get('direction') || currentDirection;
                console.log("Fetching data for direction:", directionForAPI);

                const response = await fetch(`/api/data?direction=${directionForAPI}`);
                console.log("Response status:", response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                console.log("Data received from API:", data);

                let element;

                console.log("Attempting to update from-stop-name. Element ID: 'from-stop-name'");
                element = document.getElementById('from-stop-name');
                if (!element) { console.error("'from-stop-name' not found!"); throw new Error("'from-stop-name' not found!");}
                element.textContent = data.from_stop;

                console.log("Attempting to update to-stop-name. Element ID: 'to-stop-name'");
                element = document.getElementById('to-stop-name');
                if (!element) { console.error("'to-stop-name' not found!"); throw new Error("'to-stop-name' not found!");}
                element.textContent = data.to_stop;

                // ★ ページタイトル全体の更新に変更
                console.log("Attempting to update document title.");
                document.title = `バス接近情報 ${data.from_stop} → ${data.to_stop}`;
                console.log("Document title updated to:", document.title);

                // ★ 'title-from-stop' と 'title-to-stop' のIDを持つspanへの更新処理は削除

                console.log("Attempting to update server-status-indicator and server-status-text. Element IDs: 'server-status-indicator', 'server-status-text'");
                const statusIndicator = document.getElementById('server-status-indicator');
                const statusText = document.getElementById('server-status-text');
                if (!statusIndicator) console.error("'server-status-indicator' not found!");
                if (!statusText) console.error("'server-status-text' not found!");

                if (statusIndicator && statusText) {
                    if (data.system_status) {
                        if (data.system_status.healthy) {
                            statusIndicator.className = 'indicator green';
                            statusText.textContent = '作動中';
                        } else if (data.system_status.warning) {
                            statusIndicator.className = 'indicator yellow';
                            statusText.textContent = '一部注意あり';
                        } else {
                            statusIndicator.className = 'indicator red';
                            statusText.textContent = '停止またはエラー';
                        }
                    } else {
                        statusIndicator.className = 'indicator';
                        statusText.textContent = '状態不明';
                    }
                }

                console.log("Attempting to get weather-info-area. Element ID: 'weather-info-area'");
                const weatherInfoArea = document.getElementById('weather-info-area');
                if (!weatherInfoArea) { console.error("'weather-info-area' not found!"); throw new Error("'weather-info-area' not found!");}

                console.log("Attempting to update weather-last-updated. Element ID: 'weather-last-updated'");
                const weatherLastUpdatedSpan = document.getElementById('weather-last-updated');
                if (!weatherLastUpdatedSpan) { console.error("'weather-last-updated' not found!"); throw new Error("'weather-last-updated' not found!");}

                let weatherHtml = '';
                if (data.weather_data) {
                    if (data.weather_data.error_message) {
                        weatherHtml = `<p class="error-message">天気情報: ${data.weather_data.error_message}</p>`;
                    } else if (data.weather_data.condition) {
                        weatherHtml = `<p><strong>伊勢原の天気:</strong> ${data.weather_data.description || data.weather_data.condition}
                                       ${data.weather_data.temp_c !== null ? ` (${data.weather_data.temp_c.toFixed(1)}℃)` : ''}
                                       ${data.weather_data.is_rain ? ' <span class="urgent-text">傘を忘れずに！</span>' : ''}
                                     </p>`;
                    } else {
                        weatherHtml = '<p>天気情報なし</p>';
                    }
                } else {
                    weatherHtml = '<p>天気情報取得エラー</p>';
                }
                const weatherContentParagraph = weatherInfoArea.querySelector('p:not(.last-updated-label)');
                if (weatherContentParagraph) {
                    weatherContentParagraph.outerHTML = weatherHtml;
                } else {
                    weatherInfoArea.insertAdjacentHTML('afterbegin', weatherHtml);
                }
                if (weatherLastUpdatedSpan && data.weather_last_updated_str) {
                    weatherLastUpdatedSpan.textContent = data.weather_last_updated_str;
                }

                console.log("Attempting to update bus-last-updated. Element ID: 'bus-last-updated'");
                const busLastUpdatedSpan = document.getElementById('bus-last-updated');
                if (!busLastUpdatedSpan) { console.error("'bus-last-updated' not found!"); throw new Error("'bus-last-updated' not found!");}
                busLastUpdatedSpan.textContent = data.bus_last_updated_str || "N/A";


                console.log("Attempting to get bus-info-container. Element ID: 'bus-info-container'");
                const busInfoContainer = document.getElementById('bus-info-container');
                if (!busInfoContainer) { console.error("'bus-info-container' not found!"); throw new Error("'bus-info-container' not found!");}

                let busesHtml = '';
                if (data.bus_error_message) {
                    busesHtml = `<p class="error-message" data-bus-error>バス情報取得エラー: ${data.bus_error_message}</p>`;
                } else if (data.buses_to_display && data.buses_to_display.length > 0) {
                    busesHtml += '<ul class="bus-list">';
                    data.buses_to_display.forEach((bus, index) => {
                        busesHtml += `
                            <li class="bus-item ${bus.is_urgent ? 'urgent' : ''}">
                                <p>
                                    <strong>${index + 1}. ${bus.departure_time.replace(/\(予定通り\)|\(予定\)|\(遅延可能性あり\)/g, '').trim()}</strong>
                                    ${bus.departure_time.includes("(予定通り)") ? ' (予定通り)' : ''}
                                    ${bus.departure_time.includes("(予定)") ? ' (予定)' : ''}
                                    ${bus.departure_time.includes("(遅延可能性あり)") ? ' (遅延可能性あり)' : ''}
                                    ${(bus.time_until_departure && !bus.departure_time.includes(bus.time_until_departure)) ? `<span class="time-until-text">(${bus.time_until_departure})</span>` : ''}
                                </p>
                                ${bus.status_text.includes("予定通り発車します") ? `<p class="details status-on-time">予定通り発車します</p>` : ''}
                                </li>`;
                    });
                    busesHtml += '</ul>';
                } else {
                    let noBusMsg = '現在、利用可能なバス情報はありません。';
                     if (data.buses_to_display && data.buses_to_display.length === 0 && !data.bus_error_message) {
                        noBusMsg = '現在表示できるバス情報はありません。運行時間外か、本日の運行は終了した可能性があります。';
                    }
                    busesHtml = `<p class="info-message" data-bus-info>${noBusMsg}</p>`;
                }
                busInfoContainer.innerHTML = busesHtml;

                if (data.current_direction) {
                    currentDirection = data.current_direction;
                    setActiveLink();
                }

            } catch (error) {
                console.error('データ更新に失敗しました (catch block):', error);
                const busInfoContainer = document.getElementById('bus-info-container');
                if (busInfoContainer) {
                    busInfoContainer.innerHTML = `<p class="error-message">データ更新に失敗しました。サーバーとの通信を確認してください。</p>`;
                }
                const statusIndicator = document.getElementById('server-status-indicator');
                const statusText = document.getElementById('server-status-text');
                if (statusIndicator) statusIndicator.className = 'indicator red';
                if (statusText) statusText.textContent = '通信エラー';
                const weatherLastUpdatedSpan = document.getElementById('weather-last-updated');
                 if (weatherLastUpdatedSpan) {
                    weatherLastUpdatedSpan.textContent = 'N/A';
                }
            }
        }

        updateCurrentTime();
        setInterval(updateCurrentTime, 1000);
        fetchAndUpdateData();
        if (dataUpdateInterval > 0) {
            setInterval(fetchAndUpdateData, dataUpdateInterval);
        }
    </script>
</body>
</html>
